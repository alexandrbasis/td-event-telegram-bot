#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥—ã TD Bot
# –í–ê–ñ–ù–û: –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —á–µ—Ä–µ–∑ 'source ./activate_venv.sh' –∏–ª–∏ '. ./activate_venv.sh'

echo "ü§ñ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥—ã TD Bot..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ source, –∏–Ω–∞—á–µ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è
is_sourced=false
# bash
if [ -n "$BASH_VERSION" ]; then
  if [ "${BASH_SOURCE[0]}" != "$0" ]; then
    is_sourced=true
  fi
fi
# zsh
if [ -n "$ZSH_VERSION" ]; then
  case $ZSH_EVAL_CONTEXT in
    *:file) is_sourced=true;;
  esac
fi

if [ "$is_sourced" != true ]; then
  echo ""
  echo "‚ùå –û–®–ò–ë–ö–ê: –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!"
  echo ""
  echo "üîß –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞:"
  echo "   source ./activate_venv.sh"
  echo "   –∏–ª–∏"
  echo "   . ./activate_venv.sh"
  echo ""
  echo "‚ö†Ô∏è  –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ './activate_venv.sh', –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞"
  echo "   –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞."
  echo ""
  return 2 2>/dev/null || exit 2
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "venv" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ venv –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞."
    exit 1
fi

# –î–ª—è zsh –≤–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ (–µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ)
if [ -n "$ZSH_VERSION" ]; then
    setopt PROMPT_PERCENT 2>/dev/null || true
    setopt PROMPT_SUBST 2>/dev/null || true
fi

# –ö–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥—ã –≤ –ø—Ä–æ–º–ø—Ç–µ
export VIRTUAL_ENV_PROMPT="(TD Bot) "

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è zsh –µ—Å–ª–∏ –æ–Ω —Å–ª–æ–º–∞–Ω
if [ -n "$ZSH_VERSION" ] && [[ "$PS1" == *"%n@%m"* ]]; then
    # –ï—Å–ª–∏ –ø—Ä–æ–º–ø—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—ã—Ä—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–º–ø—Ç
    export PS1="(TD Bot) %~ $ "
fi

# –£–±–∏—Ä–∞–µ–º –∞–ª–∏–∞—Å python –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
unalias python 2>/dev/null || true

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å—Ä–µ–¥—É
source venv/bin/activate

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é
if [ "$VIRTUAL_ENV" != "" ]; then
    echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞: $VIRTUAL_ENV"
    echo "üêç Python –≤–µ—Ä—Å–∏—è: $(python --version)"
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:"
    pip list | grep -E "(python-telegram-bot|pyairtable|python-dotenv)" | sed 's/^/   /'
    echo ""
    echo "üöÄ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π: python main.py"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
    exit 1
fi
