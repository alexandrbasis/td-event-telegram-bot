# Task: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ConversationHandler States Priority

**Created**: January 28, 2025  
**Status**: Completed ‚úÖ  
**Estimated Effort**: 30 minutes  

## Business Context

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –∑–∞–ø—É—Å–∫–∞, –≤—ã—è–≤–∏–ª–∞—Å—å **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞**:

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- –ù–∞–∂–∏–º–∞—é—Ç –∫–Ω–æ–ø–∫—É "üîç –ü–æ–∏—Å–∫" ‚Üí –ø–æ–ª—É—á–∞—é—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ ‚Üí –ø–æ–ª—É—á–∞—é—Ç –∑–∞–≥–ª—É—à–∫—É "NLP –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"
- –ù–∞–∂–∏–º–∞—é—Ç –∫–Ω–æ–ø–∫—É "‚ûï –î–æ–±–∞–≤–∏—Ç—å" ‚Üí –ø–æ–ª—É—á–∞—é—Ç —à–∞–±–ª–æ–Ω ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ‚Üí –ø–æ–ª—É—á–∞—é—Ç –∑–∞–≥–ª—É—à–∫—É
- ConversationHandler —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ë–∏–∑–Ω–µ—Å-—Ä–∏—Å–∫–∏:**
- –ü–æ–ª–Ω–∞—è –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (–ø–æ–∏—Å–∫ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)  
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—ã –Ω–µ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –±–∞–∑–æ–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—ã–Ω—É–∂–¥–µ–Ω—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑

## Technical Analysis  

### ‚úÖ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê

**MessageHandler –∑–∞–≥–ª—É—à–∫–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ ConversationHandler states —É—Å–ø–µ–≤–∞—é—Ç –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å:

```python
# main.py —Å—Ç—Ä–æ–∫–∞ 3348 - –ü–†–û–ë–õ–ï–ú–ê –ë–´–õ–ê –ó–î–ï–°–¨:
application.add_handler(
    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message), group=1  # ‚Üê –ì—Ä—É–ø–ø–∞ 1!
)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. ‚úÖ –ö–Ω–æ–ø–∫–∞ "üîç –ü–æ–∏—Å–∫" ‚Üí `handle_search_callback` ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ `SEARCHING_PARTICIPANTS`
2. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" ‚Üí –¥–æ–ª–∂–Ω–æ –ø–æ–ø–∞—Å—Ç—å –≤ `handle_search_input` 
3. ‚ùå **–ù–û** –∑–∞–≥–ª—É—à–∫–∞ –≤ –≥—Ä—É–ø–ø–µ 1 –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –†–ê–ù–¨–®–ï ConversationHandler (–≥—Ä—É–ø–ø–∞ 0)

### ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û

–ò–∑–º–µ–Ω–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç MessageHandler –∑–∞–≥–ª—É—à–∫–∏ —Å –≥—Ä—É–ø–ø—ã 1 –Ω–∞ –≥—Ä—É–ø–ø—É 10:

```python  
# main.py —Å—Ç—Ä–æ–∫–∞ 3348 - –ò–°–ü–†–ê–í–õ–ï–ù–û:
application.add_handler(
    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message), group=10  # ‚Üê –ì—Ä—É–ø–ø–∞ 10!
)
```

**–¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:**
1. **–ì—Ä—É–ø–ø–∞ -2**: Debug middleware
2. **–ì—Ä—É–ø–ø–∞ -1**: Logging middleware  
3. **–ì—Ä—É–ø–ø–∞ 0**: ConversationHandlers (search_conv, add_conv) ‚Üê **–ü–†–ò–û–†–ò–¢–ï–¢**
4. **–ì—Ä—É–ø–ø–∞ 0**: Command handlers (/start, /help)
5. **–ì—Ä—É–ø–ø–∞ 10**: Fallback –∑–∞–≥–ª—É—à–∫–∞ ‚Üê **–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª**

## Expected Flow After Fix

### üîç –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üîç –ü–æ–∏—Å–∫" ‚Üí `handle_search_callback` ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ `SEARCHING_PARTICIPANTS`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" ‚Üí –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `handle_search_input` ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–∏—Å–∫ ‚úÖ

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞:  
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "‚ûï –î–æ–±–∞–≤–∏—Ç—å" ‚Üí `handle_add_callback` ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ `COLLECTING_DATA`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ‚Üí –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `handle_partial_data` ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö ‚úÖ

### üí¨ –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ConversationHandler, —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∑–∞–≥–ª—É—à–∫—É

## Implementation Steps

### Phase 1: Priority Fix ‚úÖ  
- [x] ‚úÖ **Completed**: –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç MessageHandler —Å –≥—Ä—É–ø–ø—ã 1 –Ω–∞ –≥—Ä—É–ø–ø—É 10
- [x] ‚úÖ **Completed**: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

### Phase 2: Testing & Validation ‚úÖ
- [x] ‚úÖ **Completed**: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –±–µ–∑ –æ—à–∏–±–æ–∫ - –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- [x] ‚úÖ **Completed**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞ - PTBUserWarning –ø—Ä–æ `per_message=True`
- [x] ‚úÖ **Completed**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ `per_message=True` ‚Üí `per_message=False` –≤ –æ–±–æ–∏—Ö ConversationHandlers
- [x] ‚úÖ **Completed**: –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ PTBUserWarning –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è  

### Phase 3: Documentation ‚úÖ
- [x] ‚úÖ **Completed**: –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
- [x] ‚úÖ **Completed**: –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ task –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏

## Success Criteria

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
- [ ] **–ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –∫–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ ‚Üí –≤–≤–æ–¥ –∏–º–µ–Ω–∏ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
- [ ] **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å ‚Üí –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–∞  
- [ ] **Fallback —Ä–∞–±–æ—Ç–∞–µ—Ç**: —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω–µ conversation ‚Üí –∑–∞–≥–ª—É—à–∫–∞
- [ ] **Slash-–∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç**: /search, /add —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
- [ ] ConversationHandler states –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ç–µ–∫—Å—Ç –≤ –≥—Ä—É–ø–ø–µ 0
- [ ] MessageHandler fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–µ 10
- [ ] –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## Risks & Mitigation

- **Risk**: Fallback –∑–∞–≥–ª—É—à–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ‚Üí **Mitigation**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω–µ conversation
- **Risk**: ConversationHandlers —Å–ª–æ–º–∞—é—Ç—Å—è ‚Üí **Mitigation**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **Risk**: Command handlers –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç ‚Üí **Mitigation**: –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ slash-–∫–æ–º–∞–Ω–¥—ã –≤ –≥—Ä—É–ø–ø–µ 0

---

## üéØ CURRENT STATUS: PRIORITY FIX APPLIED  

**‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ** - MessageHandler –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–∑–º–µ–Ω–µ–Ω —Å –≥—Ä—É–ø–ø—ã 1 –Ω–∞ –≥—Ä—É–ø–ø—É 10.

**üß™ Next Step**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
1. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—à–∏–±–æ–∫
2. –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ ‚Üí –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–∏—Å–∫–∞  
3. –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ‚Üí –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞

**üìà Expected Result**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å!
