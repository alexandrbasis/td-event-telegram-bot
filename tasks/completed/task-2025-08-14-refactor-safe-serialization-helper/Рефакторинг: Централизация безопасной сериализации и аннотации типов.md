# Task: Рефакторинг: Централизация безопасной сериализации и аннотации типов

**Created**: August 14, 2025  
**Status**: Draft

## Business Context
Безопасная сериализация данных пользователя используется логирующими декораторами и критична для корректных переходов состояний в поисковом flow. Вынесение функции `_safe_serialize_user_data` в общий модуль и добавление аннотаций типов уменьшают дублирование, повышают сопровождаемость и предотвращают регрессии.

## Technical Requirements
- [ ] Вынести `_safe_serialize_user_data` в `utils/logging_helpers.py` с аннотациями типов
- [ ] Заменить обращения в `main.py` на импорт из общего помощника
- [ ] Обновить тесты для использования общего помощника
- [ ] Запустить весь тестовый набор и убедиться, что всё зелёное

## Implementation Steps
- [ ] Шаг 1: Создать `utils/logging_helpers.py` и перенести логику безопасной сериализации
- [ ] Шаг 2: Обновить импорты и удалить локальную реализацию в `main.py`
- [ ] Шаг 3: Обновить `tests/test_json_serialization_fix.py` для импорта помощника
- [ ] Шаг 4: Прогон тестов `./venv/bin/python -m unittest discover tests -v`

## Dependencies
- Логирующие декораторы в `main.py` (`log_state_transitions`, `smart_cleanup_on_error`)
- Тесты: `tests/test_json_serialization_fix.py`

## Risks & Mitigation
- **Risk**: Нарушение импорта в тестах → **Mitigation**: Явный импорт из `utils.logging_helpers`, проверка `sys.path` в тестах
- **Risk**: Непредвиденное влияние на сериализацию других ключей → **Mitigation**: Сохранить существующую семантику функции 1:1

## Testing Strategy
- [ ] Запустить полный тестовый набор
- [ ] Особо проверить: `tests/test_json_serialization_fix.py`, async-флоу поиска

## Documentation Updates Required
- [ ] Обновить `docs/tests-structure.md` (примечание о переносе помощника в `utils/logging_helpers.py`)

## Success Criteria
- [ ] Единая реализация `_safe_serialize_user_data` в `utils/logging_helpers.py`
- [ ] Все ссылки обновлены, локальная копия удалена из `main.py`
- [ ] Тесты проходят без регрессий

## Linear Issue Reference
- **Linear Issue ID**: TDB-7
- **Linear Issue URL**: https://linear.app/alexandrbasis/issue/TDB-7/refactor-centralize-safe-serialization-helper-and-add-type-hints


